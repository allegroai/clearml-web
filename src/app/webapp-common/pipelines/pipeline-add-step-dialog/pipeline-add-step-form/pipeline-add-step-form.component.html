<form (submit)="pipelineForm.invalid && send()" #pipelineForm='ngForm' class="d-flex flex-column">
  <mat-form-field appearance="outline" hideRequiredMarker class="mat-light">
    <mat-label>Step name</mat-label>
    <mat-error *ngIf="name.touched && name.errors?.required">*Please add name.</mat-error>
    <mat-error *ngIf="name.touched && name.errors?.uniqueName">*Step name already exists.</mat-error>
    <mat-error *ngIf="name.touched && name.errors?.minlength">*Step name should contain more than 3
      characters.</mat-error>
    <input name="stepName" [(ngModel)]="step.name" #name="ngModel" matInput autocomplete="off"
      smUniqueNameValidator [existingNames]="experimentsNames" required minlength="3">
  </mat-form-field>
  <mat-form-field class="w-100" appearance="outline"
    (mousedown)="!isFocused(experimentInputRef) && experimentInput.value && experimentInput.reset(); experimentInputRef.blur(); experimentInputRef.focus()">
    <mat-label>Experiment</mat-label>
    <input matInput type="text" [matAutocomplete]="auto" [ngModel]="step.experiment" name="experimentName"
      placeholder="Search for existing experiments" #experimentInputRef #experimentInput="ngModel" required
      (keydown.enter)="experimentInput.control.markAsTouched()" [smExistNameValidator]="experimentsNames"
      smUniqueNameValidator >
    <i matSuffix class="al-icon sm-md search-icon me-2"
      [ngClass]="experimentInput.value? 'al-ico-dialog-x pointer':'al-ico-search'"
      (mousedown)="!isFocused(experimentInputRef) && experimentInput.value && clear(); experimentInput.reset(); experimentInputRef.focus(); step.parameters = [];"
      smClickStopPropagation></i>
    <mat-error *ngIf="experimentInput?.errors?.existName">Please provide a experiment</mat-error>
    <mat-error *ngIf="experimentInput?.errors?.uniqueName && !readOnlyExperimentsNames.includes(step.experiment?.label)">Please
      provide a different name as this experiment name is taken as an Example project
    </mat-error>
    <mat-autocomplete #auto="matAutocomplete" class="light-theme" [displayWith]="displayFn"
      (opened)="setIsAutoCompleteOpen(true)" (closed)="setIsAutoCompleteOpen(false)" autoActiveFirstOption>
      <!--      Currently we don't have create new project in create report-->
      <!--      <mat-option-->
      <!--        class="item"-->
      <!--        *ngIf="projects !== null && experimentInput.value && !(experimentInput.value | stringIncludedInArray:projectsNames)"-->
      <!--        [value]="experimentInput.value"-->
      <!--        (onSelectionChange)="createNewSelected($event)"-->
      <!--      >"{{experimentInput.value}}" <span class="new">(Create New)</span></mat-option>-->
      <mat-option *ngFor="let experiment of experimentsOptions; trackBy: trackByValue" [value]="experiment"
        [smTooltip]="experiment.label" smShowTooltipIfEllipsis (onSelectionChange)="experimentSelected($event)">
        <div [smSearchText]="experimentInput.value">{{experiment.label}}</div>
      </mat-option>
      <div *ngIf="experiments === null" class="p-4 pe-none">
        <mat-spinner class="m-auto" [diameter]="32" [strokeWidth]="4" color="accent"></mat-spinner>
      </div>
      <div *ngIf="experiments && !noMoreOptions" (smScrollEnd)="!loading && loadMore(experimentInput.value)"
        class="text-center">Loading more...</div>
      <mat-option disabled style="height: 0; min-height: 0;"></mat-option>
      <!-- Empty mat-option, so the autocomplete menu will always pop -->
    </mat-autocomplete>
  </mat-form-field>
  <mat-form-field appearance="outline" hideRequiredMarker>
    <mat-error *ngIf="description?.touched && description?.invalid">*Please add description.
    </mat-error>
    <mat-label>Description</mat-label>
    <textarea class="step-description" name="description" matInput [(ngModel)]="step.description"
      #description="ngModel"></textarea>
  </mat-form-field>
  <div class="parameters" *ngIf="step?.parameters?.length">
    <div class="search">
      <mat-label>Parameters</mat-label>
      <sm-search search-button
      #search
      class="table-search"
      [value]="searchedText"
      [enableNavigation]="true"
      [minimumChars]="1"
      [debounceTime]="0"
      [expandOnHover]="true"
      [searchResultsCount]="searchResultsCount"
      [searchCounterIndex]="stepParamsForm.matchIndex"
      (valueChanged)="searchTable($event)"
    ></sm-search>
    </div>
    <sm-pipeline-parameters
    #stepParamsForm
    class="form-section"
    [section]=""
    [formData]="step?.parameters"
    (formDataChanged)="onFormValuesChanged($event)"
    (searchCounterChanged)="searchCounterChanged($event)"
    (resetSearch)="search.clear(false)"
    (scrollToResultCounterReset)="scrollIndexCounterReset()"
  ></sm-pipeline-parameters>
  </div>
  <div class="w-100 create-step-button">
    <button class="btn btn-dark-fill center" data-id="Create Step" [disabled]="pipelineForm.invalid"
      (click)="send()">ADD STEP
    </button>
  </div>
</form>